{% extends "base.html" %}

{% block title %}
  {{ session.title }}
{% endblock %}

{% block content %}
  <div class="py-5">
    <h2>{{ session.title }}</h2>
    <div id="msg-container" class="border p-3 mb-3" style="height:60vh; overflow-y:auto;">
      {% for msg in session.messages.all %}
        <div class="my-2 text-{{ msg.is_user|yesno:'end,start' }}">
              <div
                class="badge bg-{{ msg.is_user|yesno:'primary,secondary' }} text-start"
               style="white-space: pre-wrap;"
             >
                {{ msg.content|linebreaksbr }}
            </div>
              <!-- Kopyala ikonu -->
        <button 
        class="btn btn-sm btn-outline-light copy-btn" 
        data-content="{{ msg.content|escapejs }}" 
        title="Mesajı kopyala"
        style="font-size: 0.85rem;">
        <i class="bi bi-clipboard"></i>
      </button>
        </div>
      {% empty %}
        <div class="text-muted">Henüz mesaj yok.</div>
      {% endfor %}
    </div>

    <div class="input-group">
      <input id="msg-input" type="text" class="form-control" placeholder="Mesajınızı yazın…">
      <button id="send-btn" class="btn btn-primary">Gönder</button>
    </div>
  </div>

  <script>
    const sessionId = {{ session.id }};
    const input     = document.getElementById('msg-input');
    const btn       = document.getElementById('send-btn');
    const container = document.getElementById('msg-container');
  
    function formatContent(text) {
      const div = document.createElement('div');
      div.textContent = text;
      let escaped = div.innerHTML;
      return escaped.replace(/\n/g, '<br>');
    }
  
    async function sendMessage() {
      const raw = input.value.trim();
      if (!raw) return;
  
      btn.disabled = true;
  
      // Kullanıcı mesajını ekle
      container.insertAdjacentHTML('beforeend', `
        <div class="my-2 text-end">
          <div class="badge bg-primary text-start" style="white-space: pre-wrap;">
            ${formatContent(raw)}
          </div>
        </div>`);
      container.scrollTop = container.scrollHeight;
  
      // API çağrısı
      const resp = await fetch(`/chat/${sessionId}/send/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({message: raw})
      });
      const data = await resp.json();
  
      // AI cevabını ekle
      if (data.ai) {
        container.insertAdjacentHTML('beforeend', `
          <div class="my-2 text-start">
            <div class="badge bg-secondary text-start" style="white-space: pre-wrap;">
              ${formatContent(data.ai.content)}
            </div>
          </div>`);
        container.scrollTop = container.scrollHeight;
      }
  
      input.value = '';
      btn.disabled = false;
    }
  
    // Buton tıklamasını dinle
    btn.addEventListener('click', sendMessage);
  
    // Enter tuşuna basılınca da gönder
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();  // satır sonu eklemek istemiyorsak
        sendMessage();
      }
    });
    document.querySelectorAll('.copy-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const text = btn.getAttribute('data-content');
      navigator.clipboard.writeText(text)
        .then(() => {
          // İsteğe bağlı: kısa bir bildirim
          btn.innerHTML = '<i class="bi bi-clipboard-check"></i>';
          setTimeout(() => btn.innerHTML = '<i class="bi bi-clipboard"></i>', 1000);
        })
        .catch(err => {
          console.error('Kopyalama hatası:', err);
        });
    });
  });    
  </script>
{% endblock %}
